#!/bin/bash
set -euo pipefail; IFS=$'\n\t'

help () {
  cat <<-'EOF'
build
Scripts which packages AWS CLI v2 into an AppImage binary.

Usage:
  ./build <version> [arch]
  ./build [-h|--help]

  <version>     Version of AWS CLI
  [arch]        Architecture to build, default to your arch
  -h, --help    Display this message

Example:
  ./build 2.0.0 x86_64
  ./build 2.1.14 aarch64
  ./build -h
  ./build --help
EOF
}

if [ $# -eq 0 ]; then
  help
  exit 1
fi

if [[ "${1}" == '-h' || "${1}" == '--help' ]]; then
  help
  exit
fi

VERSION="${1}"
ARCH="${2:-$(uname -m)}"

echo "AWS CLI v2, in a single file - ${VERSION} ${ARCH}"

if [[ $ARCH != 'x86_64' && $ARCH != 'aarch64' ]]; then
  echo Unsupported architecture specified! Arch should be x86_64 or aarch64.
  exit
fi

# Reference: https://docs.appimage.org/packaging-guide/manual.html
mkdir -p aws.AppDir/usr

# Download AppImageKit
curl -L "https://github.com/AppImage/AppImageKit/releases/download/12/appimagetool-$(uname -m).AppImage" -o appimagetool
curl -L "https://github.com/AppImage/AppImageKit/releases/download/12/AppRun-${ARCH}" -o aws.AppDir/AppRun
curl -L "https://github.com/AppImage/AppImageKit/releases/download/12/runtime-${ARCH}" -o runtime
chmod +x appimagetool aws.AppDir/AppRun

# Download and extract AWSCliv2
curl "https://awscli.amazonaws.com/awscli-exe-linux-${ARCH}-${VERSION}.zip" -o aws.zip
unzip -q aws.zip 'aws/dist/*'
mv aws/dist aws.AppDir/usr/bin

# Reference: https://wiki.archlinux.org/index.php/desktop_entries
cat <<'EOF' > aws.AppDir/aws.desktop
[Desktop Entry]
Name=aws
Exec=aws
Icon=aws
Type=Application
Categories=Utility;ConsoleOnly;
Terminal=true
EOF

# Logo is retrieved from AWS Architecture Icons, minified with svgcleaner
#
# References:
#   https://aws.amazon.com/architecture/icons/
#   https://commons.wikimedia.org/wiki/File:AWS_Simple_Icons_AWS_Cloud.svg
#   https://github.com/RazrFalcon/svgcleaner
cat <<'EOF' > aws.AppDir/aws.svg
<svg enable-background="new 0 0 70 70" viewBox="14.7 23 42 26.2"
xmlns="http://www.w3.org/2000/svg"><path d="m27.09 35.764-1.106
4.576h2.198l-1.067-4.576z" fill="#f7981f"/><path d="m16.302 40.744v.666c0 3.311
3.579 6.66 7.991 6.66h23.533c4.412 0 7.991-3.35
7.991-6.66v-.666c0-3.078-3.098-6.943-7.081-7.283-.089-2.752-2.342-4.955-5.113-4.955-1.076
0-2.074.334-2.898.9-1.58-3.52-5.107-5.977-9.216-5.977-5.579 0-10.101
4.521-10.101 10.102 0 .1.012.195.015.293-2.993.867-5.121 4.371-5.121
6.92zm12.699 3.055-.572-2.275h-2.717l-.599 2.275h-1.547l2.639-9.283h1.898l2.444
9.283zm9.012 0h-1.716l-1.196-6.994h-.026l-1.183
6.994h-1.716l-1.795-9.283h1.496l1.221 7.215h.027l1.221-7.215h1.561l1.248
7.254h.026l1.209-7.254h1.469zm5.433.181c-2.301
0-2.821-1.533-2.821-2.834v-.221h1.482v.234c0 1.131.494 1.703 1.521 1.703.936 0
1.403-.664 1.403-1.354
0-.975-.493-1.404-1.325-1.65l-1.015-.352c-1.353-.52-1.937-1.221-1.937-2.547
0-1.691 1.144-2.627 2.886-2.627 2.379 0 2.626 1.482 2.626
2.443v.209h-1.482v-.195c0-.846-.377-1.34-1.3-1.34-.637 0-1.248.352-1.248 1.34 0
.793.403 1.195 1.392 1.572l1 .365c1.313.467 1.886 1.184 1.886 2.457.001
1.979-1.196 2.797-3.068 2.797z" fill="#f7981f"/><g fill="#fff"><path d="m26.205
34.516-2.639 9.283h1.547l.599-2.275h2.717l.572 2.275h1.547l-2.444-9.283zm-.221
5.824 1.105-4.576h.025l1.066 4.576z"/><path d="m37.181
41.77h-.027l-1.248-7.254h-1.56l-1.221 7.214h-.027l-1.221-7.214h-1.496l1.795
9.283h1.716l1.182-6.994h.027l1.196 6.994h1.716l1.845-9.283h-1.468z"/><path
d="m44.629 38.729-1-.365c-.988-.377-1.392-.779-1.392-1.572 0-.988.611-1.34
1.248-1.34.923 0 1.3.494 1.3
1.34v.195h1.482v-.209c0-.961-.247-2.443-2.626-2.443-1.742 0-2.886.936-2.886
2.627 0 1.326.584 2.027 1.937 2.547l1.015.352c.832.246 1.325.676 1.325 1.65 0
.689-.468 1.354-1.403 1.354-1.027 0-1.521-.572-1.521-1.703v-.234h-1.482v.221c0
1.301.521 2.834 2.821 2.834 1.872 0 3.068-.818 3.068-2.795
0-1.276-.573-1.993-1.886-2.459z"/></g></svg>
EOF

# Package
./appimagetool -n aws.AppDir --runtime-file ./runtime
